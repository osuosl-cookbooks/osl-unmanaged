# Generated by Chef for <%= node['fqdn'] %>
#
# See slapd.conf(5) for details on configuration options.
# This file should NOT be world readable.
#

include  /etc/openldap/schema/core.schema
include  /etc/openldap/schema/cosine.schema
include  /etc/openldap/schema/inetorgperson.schema
include  /etc/openldap/schema/nis.schema

include  /etc/openldap/schema/samba.schema
include  /etc/openldap/schema/ldapns.schema
include  /etc/openldap/schema/openssh-lpk.schema

sizelimit  unlimited
loglevel   sync

# Allow LDAPv2 client connections.  This is NOT the default.
allow bind_v2

pidfile  /var/run/openldap/slapd.pid
argsfile /var/run/openldap/slapd.args

# The next three lines allow use of TLS for encrypting connections using a
# dummy test certificate which you can generate by running
# /usr/libexec/openldap/generate-server-cert.sh. Your client software may balk
# at self-signed certificates, however.
TLSCertificateFile <%= node['osl-slapd']['TLSCertficateFile'] %>
TLSCertificateKeyFile <%= node['osl-slapd']['TLSCertficateKeyFile'] %>
TLSCACertificateFile <%= node['osl-slapd']['TLSCACertficateFile'] %>

# Sample security restrictions
#  Require integrity protection (prevent hijacking)
#  Require 112-bit (3DES or better) encryption for updates
#  Require 63-bit encryption for simple bind
security ssf=1 update_ssf=112 simple_bind=64

# enable on-the-fly configuration (cn=config)
database config
access to *
  by dn.exact="gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth" manage
  by * none

# enable server status monitoring (cn=monitor)
database monitor
access to *
  by dn.exact="gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth" read
  by dn.exact="<%= node['osl-slapd']['rootdn'] %>" read
  by * none

#######################################################################
# database definitions
#######################################################################

database  bdb
suffix    "<%= node['osl-slapd']['suffix'] %>"
checkpoint  1024 15
rootdn    "<%= node['osl-slapd']['rootdn'] %>"
rootpw    "<%= node['osl-slapd']['rootpw'] %>"

# The database directory MUST exist prior to running slapd AND 
# should only be accessible by the slapd and slap tools.
# Mode 700 recommended.
directory /var/lib/ldap

dbconfig set_cachesize 0 31457280 0

# Number of objects that can be locked at the same time.
dbconfig set_lk_max_objects 1500
# Number of locks (both requested and granted)
dbconfig set_lk_max_locks 1500
# Number of lockers
dbconfig set_lk_max_lockers 1500


# Indices to maintain for this database
index default                           eq
index uniqueMember                      eq
index objectClass                       eq,pres
index ou,cn,mail,surname,givenname      eq,pres,sub
index uidNumber,gidNumber,loginShell    eq,pres
index uid,memberUid                     eq,pres,sub
index nisMapName,nisMapEntry            eq,pres,sub

<% case node['osl-slapd']['slapd_type'] -%>
<% when "master" -%>
moduleload syncprov.la
overlay syncprov
syncprov-checkpoint 100 10
syncprov-sessionlog 100
<% when "slave" -%>
syncrepl rid=<%= node['osl-slapd']['slapd_rid'] %>
  provider=ldaps://<%= node['osl-slapd']['slapd_master'] %>:636
  type=refreshAndPersist
  retry="60 +"
  interval=01:00:00:00
  searchbase="<%= node['osl-slapd']['suffix'] %>"
  filter="(objectClass=*)"
  scope=sub
  schemachecking=off
  bindmethod=simple
  binddn="uid=syncuser,<%= node['osl-slapd']['suffix'] %>"
  credentials="<%= node['osl-slapd']['slapd_replpw'] %>"
<% end -%>

# The userPassword by default can be changed
# by the entry owning it if they are authenticated.
# Others should not be able to see it, except the
# admin entry below
# These access lines apply to database #1 only
access to attrs=userPassword,shadowLastChange
        by group.exact="<%= node['osl-slapd']['rootgroupdn'] %>" write
        by dn="uid=syncuser,<%= node['osl-slapd']['suffix'] %>" read
        by anonymous auth
        by self write
        by * none

# Ensure read access to the base for things like
# supportedSASLMechanisms.  Without this you may
# have problems with SASL not knowing what
# mechanisms are available and the like.
# Note that this is covered by the 'access to *'
# ACL below too but if you change that as people
# are wont to do you'll still need this if you
# want SASL (and possible other things) to work
# happily.
access to dn.base="" by * read

# The admin dn has full write access, everyone else
# can read everything.
access to *
        by group.exact="<%= node['osl-slapd']['rootgroupdn'] %>" write
        by dn="uid=syncuser,<%= node['osl-slapd']['suffix'] %>" read
        by * read

# Custom access configuration
<% unless node['osl-slapd']['access'].nil? -%>
<%   node['osl-slapd']['access'].each do |item| -%>
<%=    item %>
<%   end -%>
<% end -%>
